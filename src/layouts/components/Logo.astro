---
import type { ImageMetadata } from "astro";
import config from "@/config/config.json";
import ImageMod from "./ImageMod.astro";

const { src, srcDarkmode }: { src?: string; srcDarkmode?: string } =
  Astro.props;
const {
  logo,
  logo_darkmode,
  logo_width,
  logo_height,
  logo_text,
  title,
}: {
  logo: string;
  logo_darkmode: string;
  logo_width: any;
  logo_height: any;
  logo_text: string;
  title: string;
} = config.site;

const { theme_switcher }: { theme_switcher: boolean } = config.settings;

const parseDimension = (value: string | number) => {
  const numeric = Number(String(value).replace("px", ""));
  return !isNaN(numeric) && isFinite(numeric) ? numeric : undefined;
};

const resolvedLogo = src || logo;
const resolvedDarkLogo = srcDarkmode || logo_darkmode || logo;
const images = import.meta.glob("/public/images/**/*.{jpeg,jpg,png,gif,svg}");

const logoKey = resolvedLogo ? `/public${resolvedLogo}` : "";
const logoMeta: ImageMetadata | undefined =
  logoKey && images[logoKey]
    ? ((await images[logoKey]()) as { default: ImageMetadata }).default
    : undefined;

const aspectRatio =
  logoMeta?.width && logoMeta?.height
    ? logoMeta.width / logoMeta.height
    : undefined;

const widthFromConfig = parseDimension(logo_width);
const heightFromConfig = parseDimension(logo_height);

const displayWidth =
  widthFromConfig ??
  (aspectRatio && heightFromConfig
    ? Math.round(heightFromConfig * aspectRatio)
    : 150);

const displayHeight =
  aspectRatio && displayWidth
    ? Math.round(displayWidth / aspectRatio)
    : (heightFromConfig ?? 40);

const retinaWidth = displayWidth * 2;
const retinaHeight = displayHeight * 2;
---

<a
  class="navbar-brand inline-block"
  href="/"
>
  {
    resolvedLogo || resolvedDarkLogo ? (
      <>
        <ImageMod
          alt={title}
          class={`inline-block ${theme_switcher && "dark:hidden"}`}
          format="webp"
          height={retinaHeight}
          src={resolvedLogo}
          style={{
            height: `${displayHeight}px`,
            width: `${displayWidth}px`,
          }}
          width={retinaWidth}
        />
        {theme_switcher && (
          <ImageMod
            alt={title}
            class={"hidden dark:inline-block"}
            format="webp"
            height={retinaHeight}
            src={resolvedDarkLogo}
            style={{
              height: `${displayHeight}px`,
              width: `${displayWidth}px`,
            }}
            width={retinaWidth}
          />
        )}
      </>
    ) : logo_text ? (
      logo_text
    ) : (
      title
    )
  }
</a>
